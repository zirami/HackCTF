# Unexploitable_3

# Reverse

Kiểm tra một số thông tin file này
```sh
thanhnt@THANGNT-ZIR:/mnt/c/Users/n18dc/OneDrive/Desktop$ file Unexploitable_3
Unexploitable_3: ELF 64-bit LSB executable, x86-64, version 1 (SYSV), dynamically linked, interpreter /lib64/ld-linux-x86-64.so.2, for GNU/Linux 2.6.32, BuildID[sha1]=79a1ed22548f3c285a65de10be38a22ad7ccb07b, not stripped
```

Dùng lệnh checksec để xem một số cơ chế bảo mật của file

```sh
pwndbg> checksec
[*] '/mnt/c/Users/n18dc/OneDrive/Desktop/Unexploitable_3'
    Arch:     amd64-64-little
    RELRO:    Partial RELRO
    Stack:    No canary found
    NX:       NX enabled
    PIE:      No PIE (0x400000)

pwndbg>
```
Partial RELRO = dễ dàng ghi đè vùng GOT.
No canary found = easy ROP.

Dùng IDA để xem pseudo code của file.
![main_func](https://github.com/zirami/HackCTF/blob/main/Unexploitable_3/images/main.png)

Chương trình dùng hàm fwrite để in ra dòng 
`Impossible RTL ha? Nothing for you!`
rồi sau đó dùng hàm fgets để nhập 256 bytes vào biến char s[16] - BOF.


# Exploit

Khai thác chương trình này theo 2 phần:
* leak libc, tính libc base, system, binsh
* get shell.

để leak được libc thì điều quan trọng là phải sử dụng được hàm fwrite để in ra. Vì chương trình không có hàm puts hay printf mà hàm fwrite có chức năng tương tự nhưng khác ở chỗ sẽ yêu cầu nhiều tham số hơn.

```sh
   0x00000000004006a3 <+68>:    mov    rax,QWORD PTR [rip+0x2009a6]        # 0x601050 <stdout@@GLIBC_2.2.5>
   0x00000000004006aa <+75>:    mov    rcx,rax
   0x00000000004006ad <+78>:    mov    edx,0x24
   0x00000000004006b2 <+83>:    mov    esi,0x1
   0x00000000004006b7 <+88>:    mov    edi,0x400780
   0x00000000004006bc <+93>:    call   0x400520 <fwrite@plt>
```
Để dùng hàm fwrite thì cần truyền các tham số tương ứng như sau:
* rcx = <stdout@@GLIBC_2.2.5>
* edx = độ dài cần in
* esi = 0x1 - read (0), write (1), error (2)
* edi = địa chỉ chứa văn bản cần in

Sử dụng kỹ thuật RET2CSU để truyền các tham số vào các thanh ghi edx,esi,edi, nhưng thanh ghi rcx vẫn còn lại. 
Tìm một gadget cho rcx, và may mắn rằng có một gadget tương ứng.
```sh
0x0000000000400658 : mov rcx, qword ptr [rdi] ; ret
```

Tổng hợp các thứ trên lại và sắp xếp phù hợp, sẽ có thể leak được libc, từ đó get shell.
# Flag HackCTF{bss_4lw4y5_h4s_std1n/std0ut}
